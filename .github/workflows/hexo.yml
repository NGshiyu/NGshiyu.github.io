# Sample workflow for building and deploying a Hexo site to GitHub Pages
name: Deploy Hexo site to Pages

on:
  # Runs on pushes targeting the default branch [当推送到 [?] 分支时触发]
  push:
    branches: [main]

  # Allows you to run this workflow manually from the Actions tab [允许从 Actions 页面手动触发工作流]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages [为 GITHUB_TOKEN 设置权限，允许部署到 GitHub Pages]
permissions:
  contents: read      # 允许读取仓库内容
  pages: write        # 允许写入 Pages 内容
  id-token: write     # 允许使用 GitHub OIDC 令牌

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete. [设置并发策略，防止重复运行]
concurrency:
  group: "pages"           # 同组内只保留最新任务
  cancel-in-progress: false # 不取消正在运行的任务

# Default to bash
defaults:
  run:
    shell: bash

jobs:
  # Build job ------------------ 构建任务 ------------------
  build:
    runs-on: ubuntu-latest  # 使用最新 Ubuntu 环境
    steps:
      # 拉取仓库代码（包含子模块）
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive  # 同步子模块（Next 主题）

      # 配置 GitHub Pages 环境
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v5

      # 安装 Node.js 环境（用于执行 Hexo 命令）
      - name: Use Node.js 24.x
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      # 安装 Hexo 及依赖
      - name: Install Dependencies
        run: npm install

      # ✳️ 替换 _config.next.yml 文件中的占位符变量
      # 此步骤会将 ${VAR_NAME} 替换为仓库 Secrets 中的真实值
      # envsubst 是一个环境变量替换工具，可以将文件中的 ${VAR} 占位符替换成对应的环境变量值
      - name: Replace environment variables in Next config
        run: |
          echo "开始替换 _config.next.yml 中的环境变量..."
          envsubst < _config.next.yml > _config.next.resolved.yml
          cp _config.next.resolved.yml _config.next.yml
#          grep "client_id:" _config.next.resolved.yml | awk '{print length, $0}'
#          grep "client_secret:" _config.next.resolved.yml | awk '{print length, $0}'
        env:
          GITALK_GITHUB_CLIENT_ID: ${{ secrets.GITALK_GITHUB_CLIENT_ID }}
          GITALK_GITHUB_CLIENT_SECRET: ${{ secrets.GITALK_GITHUB_CLIENT_SECRET }}
          # 若有更多密钥，可继续添加：
          # VALINE_APP_ID: ${{ secrets.VALINE_APP_ID }}
          # VALINE_APP_KEY: ${{ secrets.VALINE_APP_KEY }}

      # 使用 Hexo 生成静态文件，加载替换后的配置文件
      - name: Build with Hexo
        run: npx hexo clean && npx hexo generate

      # 上传构建生成的静态文件作为 artifact（供后续部署使用）
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # ------------------ 部署任务 ------------------
  deploy:
    environment:
      name: github-pages   # 部署环境名称
      url: ${{ steps.deployment.outputs.page_url }}  # 部署完成后访问地址
    runs-on: ubuntu-latest
    needs: build           # 依赖 build 任务完成
    steps:
      # 部署到 GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4